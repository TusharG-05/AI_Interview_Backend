<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Platform</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/layout.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/animations.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ AI Interview Assistant</h1>
            <p>Practice your technical interview skills with AI-powered questions</p>
        </header>

        <!-- Camera Feed (Top Right) -->
        <div id="cameraContainer" style="position: absolute; top: 20px; right: 20px; width: 320px; height: 240px; border: 2px solid #ccc; background: black; z-index: 1000;">
            <!-- Changed from img to video for client-side stream -->
            <video id="webcamVideo" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1);"></video>
            <div style="position: absolute; bottom: 5px; left: 5px; color: white; font-size: 12px; background: rgba(0,0,0,0.5); padding: 2px;">
                Auth & Gaze Active
            </div>
        </div>

        <main>
            <!-- Setup Section -->
            <section class="form-section" id="setupSection">
                <h2>Step 1: Interview Setup</h2>
                <form id="setupForm" class="form">
                    <div class="form-group">
                        <label for="resume">
                            <strong>Upload Resume (PDF)</strong>
                            <span class="hint">Optional: We will analyze your experience from the file</span>
                        </label>
                        <input type="file" id="resume" name="resume" accept=".pdf">
                        <div class="form-group">
                             <label for="context">
                                <strong>Additional Context (Optional)</strong>
                                <span class="hint">Paste any extra details about your experience here.</span>
                            </label>
                            <textarea id="context" name="context" rows="3" placeholder="I am applying for a Senior React role..."></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Start Interview</button>
                </form>
            </section>

            <!-- Question & Answer Section -->
            <section class="question-section" id="interviewSection" style="display: none;">
                <div class="header-row" style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="progress-indicator">
                        Question <span id="currentQuestionNum">1</span> / 4
                    </div>
                    <div id="timerDisplay" style="font-weight: bold; color: #dc2626;">Time: 05:00</div>
                </div>
                
                <h2><span id="questionTypeTitle">General Question</span></h2>
                <div class="question-box">
                    <p id="currentQuestionText" class="question-text"></p>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label for="answer"><strong>Your Answer:</strong></label>
                    <textarea id="answer" name="answer" rows="6" placeholder="Type your answer here..." required></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="recordAudioBtn" class="btn btn-secondary" style="background-color: #dc2626;">üé§ Record Answer</button>
                    <span id="recordingStatus" style="display:none; color: red; font-weight: bold;">Recording...</span>
                    <button id="submitAnswerBtn" class="btn btn-primary">Submit Text Answer</button>
                </div>
            </section>

            <!-- Feedback Section (Shown after each answer) -->
            <section class="response-section" id="feedbackSection" style="display: none;">
                <h2>Feedback</h2>
                <div class="response-box">
                    <p id="feedbackText"></p>
                </div>
                <button id="nextQuestionBtn" class="btn btn-secondary">Next Question</button>
            </section>

             <!-- Completion Section -->
             <section class="response-section" id="completionSection" style="display: none;">
                <h2>Interview Complete!</h2>
                <p>Thank you for completing the interview. Your results have been recorded.</p>
                <div style="margin-top: 1rem;">
                    <a href="/candidate/dashboard" class="btn btn-primary" style="text-decoration: none;">Return to Dashboard</a>
                </div>
            </section>

            <div id="loadingIndicator" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Thinking...</p>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </main>
    </div>

    <script>
        // State Management
        const state = {
            step: 0, 
            generalQuestions: [],
            resumeText: "",
            userContext: "",
            currentQuestion: "",
            sessionId: null,
            timerInterval: null
        };

        // Auth Check
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';

        // Get Session ID
        const urlParams = new URLSearchParams(window.location.search);
        state.sessionId = urlParams.get('session_id');
        if (!state.sessionId) {
            alert("No session ID found. Returning to dashboard.");
            window.location.href = '/candidate/dashboard';
        }

        // Helpers
        function showLoading() { document.getElementById('loadingIndicator').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loadingIndicator').style.display = 'none'; }
        function showSection(id) {
            ['setupSection', 'interviewSection', 'feedbackSection', 'completionSection'].forEach(s => {
                document.getElementById(s).style.display = (s === id) ? 'block' : 'none';
            });
        }
        function showError(msg) {
            const el = document.getElementById('errorMessage');
            el.textContent = msg; el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        async function fetchWithAuth(url, options = {}) {
            options.headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
            return fetch(url, options);
        }

        // Timer Logic
        function startTimer(durationSeconds) {
            clearInterval(state.timerInterval);
            let timer = durationSeconds;
            const display = document.getElementById('timerDisplay');
            
            function updateDisplay() {
                const minutes = parseInt(timer / 60, 10);
                const seconds = parseInt(timer % 60, 10);
                display.textContent = "Time: " + (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds);
            }
            
            updateDisplay();
            state.timerInterval = setInterval(() => {
                timer--;
                updateDisplay();
                if (timer < 0) {
                    clearInterval(state.timerInterval);
                    alert("Time is up! Submitting current answer.");
                    document.getElementById('submitAnswerBtn').click();
                }
            }, 1000);
        }

        // 1. Start Interview
        document.getElementById('setupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            try {
                // Initialize Webcam
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    const videoEl = document.getElementById('webcamVideo');
                    videoEl.srcObject = stream;
                } catch (err) {
                    console.error("Webcam access error:", err);
                    alert("Please allow camera permissions to proceed.");
                    hideLoading();
                    return;
                }

                // Upload Resume & Context
                const formData = new FormData();
                const fileInput = document.getElementById('resume');
                state.userContext = document.getElementById('context').value || "";

                if (fileInput.files[0]) {
                    formData.append('resume', fileInput.files[0]);
                    const resumeRes = await fetchWithAuth('/interview/process-resume', { method: 'POST', body: formData });
                    const resumeData = await resumeRes.json();
                    state.resumeText = resumeData.text || "";
                }

                // Get General Questions (now from DB)
                const qRes = await fetchWithAuth('/interview/general-questions');
                const qData = await qRes.json();
                state.generalQuestions = qData.questions;

                // Start Flow
                state.step = 0;
                displayQuestion();

            } catch (err) {
                console.error(err);
                showError("Failed to start interview.");
            } finally {
                hideLoading();
            }
        });

        // 2. Display Logic
        async function displayQuestion() {
            showSection('interviewSection');
            document.getElementById('answer').value = "";
            document.getElementById('currentQuestionNum').textContent = state.step + 1;
            
            // Hardcoded time limit: 5 minutes per question
            startTimer(300);

            if (state.step < 2) {
                // General Questions
                document.getElementById('questionTypeTitle').textContent = "General Coding Question";
                // Depending on DB structure, property might be 'content' not 'question'
                state.currentQuestion = state.generalQuestions[state.step].content || state.generalQuestions[state.step].question;
                document.getElementById('currentQuestionText').textContent = state.currentQuestion;
            } else if (state.step < 4) {
                // Resume Questions
                document.getElementById('questionTypeTitle').textContent = "Resume-Based Question";
                showLoading();
                try {
                    const formData = new FormData();
                    formData.append('context', state.userContext);
                    formData.append('resume_text', state.resumeText);
                    
                    const res = await fetchWithAuth('/interview/generate-resume-question', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    state.currentQuestion = data.question;
                    document.getElementById('currentQuestionText').textContent = state.currentQuestion;
                } catch (err) {
                    showError("Failed to generate question.");
                } finally {
                    hideLoading();
                }
            } else {
                showSection('completionSection');
            }
        }

        // 3. Submit Answer (Text)
        document.getElementById('submitAnswerBtn').addEventListener('click', async () => {
             submitResponse('text');
        });

        // Audio Recording Logic
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        document.getElementById('recordAudioBtn').addEventListener('click', async () => {
            if (!isRecording) {
                // Start Recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        submitResponse('audio', audioBlob);
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('recordAudioBtn').textContent = "‚èπ Stop & Submit";
                    document.getElementById('recordingStatus').style.display = 'inline';
                } catch (err) {
                    alert("Microphone access denied or error: " + err);
                }
            } else {
                // Stop Recording
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('recordAudioBtn').textContent = "üé§ Record Answer";
                document.getElementById('recordingStatus').style.display = 'none';
            }
        });

        async function submitResponse(type, blob = null) {
            clearInterval(state.timerInterval);
            const textAnswer = document.getElementById('answer').value;
            
            if (type === 'text' && !textAnswer.trim()) {
                alert("Please type an answer.");
                return;
            }

            showLoading();
            try {
                let res;
                if (type === 'text') {
                    res = await fetchWithAuth(`/interview/evaluate-answer?session_id=${state.sessionId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            question: state.currentQuestion,
                            answer: textAnswer
                        })
                    });
                } else {
                    // Audio
                    const formData = new FormData();
                    formData.append('session_id', state.sessionId);
                    formData.append('question', state.currentQuestion);
                    formData.append('audio', blob, 'answer.wav');
                    
                    res = await fetchWithAuth('/interview/submit-audio', {
                        method: 'POST',
                        body: formData
                    });
                }

                const data = await res.json();
                
                if (data.transcription) {
                     document.getElementById('answer').value = data.transcription; // Show transcribed text
                }
                
                document.getElementById('feedbackText').innerHTML = `
                    <strong>Feedback:</strong> ${data.feedback} <br><br>
                    <strong>Follow-up Question:</strong> ${data.follow_up_question || "None"}
                `;
                showSection('feedbackSection');
            } catch (err) {
                console.error(err);
                showError("Submission failed.");
            } finally {
                hideLoading();
            }
        }

        // 4. Next Question
        document.getElementById('nextQuestionBtn').addEventListener('click', async () => {
            state.step++;
            if (state.step >= 4) {
                 // Finish Interview
                 showLoading();
                 try {
                     await fetchWithAuth(`/interview/finish?session_id=${state.sessionId}`, {
                         method: 'POST'
                     });
                     showSection('completionSection');
                 } catch (err) {
                     console.error(err);
                     showError("Failed to finish interview.");
                 } finally {
                     hideLoading();
                 }
            } else {
                displayQuestion();
            }
        });
    </script>
</body>
</html>
