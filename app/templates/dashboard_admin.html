<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/static/css/base.css">
    <link rel="stylesheet" href="/static/css/layout.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <style>
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .room-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .room-item:last-child {
            border-bottom: none;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 8px;
            position: relative;
            color: #1e293b;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Admin Dashboard</h1>
            <div class="actions">
                <a href="/webcam-test" target="_blank" class="btn btn-sm"
                    style="background:#4b5563; text-decoration:none;">Real-time Monitor</a>
                <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
            </div>
        </div>

        <div class="card">
            <h2>Create Interview Room</h2>
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <input type="text" id="roomPassword" placeholder="Set Room Password">
                <input type="number" id="roomMaxSessions" placeholder="Max Sessions (e.g. 10)" min="1"
                    style="width: 150px;">
                <button onclick="createRoom()" class="btn">Create Room</button>
            </div>
            <div id="newRoomInfo"
                style="margin-top: 1rem; display: none; background: #ecfdf5; padding: 1rem; border-radius: 4px;">
                <strong>Room Created!</strong> Code: <span id="roomCodeDisplay"
                    style="font-family: monospace; font-size: 1.2rem; color: #059669;"></span>
            </div>
        </div>

        <div class="card">
            <h2>Active Rooms</h2>
            <div id="roomsList">Loading...</div>
        </div>

        <div class="card">
            <h2>Interview Results / History</h2>
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>Candidate</th>
                        <th>Date</th>
                        <th>Score</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Results Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <button onclick="closeModal()"
                style="position:absolute; right:1rem; top:1rem; border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            <h2 id="modalTitle">Interview Details</h2>
            <div id="modalBody">
                <div style="margin-bottom: 2rem;">
                    <h3>Technical Review</h3>
                    <div id="qnaList"></div>
                </div>
                <hr style="border:0; border-top:1px solid #e2e8f0; margin:2rem 0;">
                <div>
                    <h3>Security Timeline (Proctoring)</h3>
                    <div id="proctoringTimeline"
                        style="background:#f8fafc; padding:1.5rem; border-radius:6px; font-family:monospace; font-size:0.9rem;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';

        let currentResults = [];

        async function fetchWithAuth(url, options = {}) {
            options.headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
            const res = await fetch(url, options);
            if (res.status === 401) { logout(); return; }
            return res;
        }

        async function createRoom() {
            const password = document.getElementById('roomPassword').value;
            const maxSessions = document.getElementById('roomMaxSessions').value;
            if (!password) return alert("Enter a password");

            const body = { password, max_sessions: maxSessions ? parseInt(maxSessions) : 30 };
            const res = await fetchWithAuth('/admin/rooms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (res.ok) {
                const data = await res.json();
                document.getElementById('roomCodeDisplay').textContent = data.room_code;
                document.getElementById('newRoomInfo').style.display = 'block';
                loadRooms();
            }
        }

        async function loadRooms() {
            try {
                const res = await fetchWithAuth('/admin/rooms');
                const rooms = await res.json();
                const container = document.getElementById('roomsList');
                if (rooms.length === 0) {
                    container.innerHTML = "<p style='color:#64748b;'>No rooms created yet.</p>";
                    return;
                }
                container.innerHTML = rooms.map(r => `
                    <div class="room-item">
                        <div>
                            Code: <strong>${r.room_code}</strong> | 
                            Status: <span style="color:${r.is_active ? '#059669' : '#dc2626'}">${r.is_active ? 'Active' : 'Inactive'}</span> | 
                            Sessions: ${r.active_sessions_count} / ${r.max_sessions}
                        </div>
                        <div class="actions">
                            <button onclick="deleteRoom(${r.id})" class="btn btn-sm btn-danger">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function deleteRoom(id) {
            if (confirm("Are you sure? This delete all sessions associated with this room.")) {
                await fetchWithAuth(`/admin/rooms/${id}`, { method: 'DELETE' });
                loadRooms();
            }
        }

        async function loadHistory() {
            try {
                const res = await fetchWithAuth('/admin/history');
                currentResults = await res.json();
                const tbody = document.querySelector('#historyTable tbody');
                if (currentResults.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; color:#64748b;'>No sessions recorded yet.</td></tr>";
                    return;
                }
                tbody.innerHTML = currentResults.map((i, idx) => `
                    <tr style="${i.flags ? 'background:#fff1f2' : ''}">
                        <td>${i.candidate}</td>
                        <td>${i.date}</td>
                        <td><strong style="color:#2563eb">${i.score}</strong></td>
                        <td>${i.flags ? '<span style="color:#e11d48; font-weight:bold;">⚠️ SECURITY ALERT</span>' : '<span style="color:#059669">Passed</span>'}</td>
                        <td><button class="btn btn-sm" onclick="showDetails(${idx})">Inspect</button></td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        function showDetails(idx) {
            const item = currentResults[idx];
            document.getElementById('modalTitle').textContent = `Audit Report: ${item.candidate}`;

            const qnaHtml = item.details.map(d => `
                <div style="margin-bottom:1.5rem; padding:1rem; border-left:4px solid #2563eb; background:#f8fafc; border-radius:0 4px 4px 0;">
                    <div style="font-weight:bold; color:#1e293b; margin-bottom:0.5rem;">Q: ${d.question}</div>
                    <div style="color:#475569; margin-bottom:0.5rem;">A: ${d.answer}</div>
                    <div style="font-size:0.875rem; font-weight:bold; color:#059669;">AI Quality Score: ${d.score}</div>
                </div>
            `).join('');
            document.getElementById('qnaList').innerHTML = qnaHtml || "<p>No interaction data found.</p>";

            const procHtml = item.proctoring_logs.map(l => `
                <div style="margin-bottom:0.4rem; padding-bottom:0.4rem; border-bottom:1px dashed #e2e8f0;">
                    <span style="color:#64748b;">[${l.time}]</span>
                    <span style="font-weight:bold; color:#dc2626; margin: 0 10px;">${l.type}</span>
                    <span>${l.details}</span>
                </div>
            `).join('');
            document.getElementById('proctoringTimeline').innerHTML = procHtml || "No security incidents flagged.";

            document.getElementById('detailsModal').style.display = 'block';
        }

        function closeModal() { document.getElementById('detailsModal').style.display = 'none'; }
        function logout() { localStorage.clear(); window.location.href = '/login'; }

        loadRooms();
        loadHistory();
        window.onclick = (e) => { if (e.target.id === 'detailsModal') closeModal(); }
    </script>
</body>

</html>