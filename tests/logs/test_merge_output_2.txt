============================= test session starts =============================
platform win32 -- Python 3.11.9, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend
configfile: pytest.ini
plugins: anyio-4.12.1, langsmith-0.6.6, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 24 items

tests/unit/test_cascade_delete.py::TestCheckDeleteEndpoint::test_check_delete_clean_user PASSED [  4%]
tests/unit/test_cascade_delete.py::TestCheckDeleteEndpoint::test_check_delete_user_with_interviews PASSED [  8%]
tests/unit/test_cascade_delete.py::TestCheckDeleteEndpoint::test_check_delete_nonexistent_user PASSED [ 12%]
tests/unit/test_cascade_delete.py::TestCascadeDelete::test_delete_candidate_cascades_interviews FAILED [ 16%]
tests/unit/test_cascade_delete.py::TestCascadeDelete::test_delete_clean_user PASSED [ 20%]
tests/unit/test_cascade_delete.py::TestCascadeDelete::test_cannot_delete_self FAILED [ 25%]
tests/unit/test_cloud_robustness.py::test_audio_service_modal_fallback_to_hf PASSED [ 29%]
tests/unit/test_cloud_robustness.py::test_audio_service_skips_local_on_cloud PASSED [ 33%]
tests/unit/test_cloud_robustness.py::test_face_recognizer_builds_sface_even_on_cloud FAILED [ 37%]
tests/unit/test_cloud_robustness.py::test_llm_fallback_to_hf PASSED      [ 41%]
tests/unit/test_interview.py::test_create_interview_session PASSED       [ 45%]
tests/unit/test_interview.py::test_access_interview_invalid_token PASSED [ 50%]
tests/unit/test_interview.py::test_access_interview_valid FAILED         [ 54%]
tests/unit/test_interview.py::test_start_session PASSED                  [ 58%]
tests/unit/test_interview.py::test_submit_answer_text PASSED             [ 62%]
tests/unit/test_interview.py::test_evaluate_answer_modal_fallback PASSED [ 66%]
tests/unit/test_total_score.py::TestTotalScoreInResultDetail::test_total_score_returned_correctly PASSED [ 70%]
tests/unit/test_total_score.py::TestTotalScoreInResultDetail::test_total_score_none_when_not_processed PASSED [ 75%]
tests/unit/test_total_score.py::TestTotalScoreInResultDetail::test_total_score_in_nested_interview_object PASSED [ 79%]
tests/unit/test_total_score.py::TestTotalScoreInResultBrief::test_total_score_in_brief_list PASSED [ 83%]
tests/unit/test_total_score.py::TestTotalScoreInResultBrief::test_zero_score_not_filtered_out PASSED [ 87%]
tests/integration/test_candidate_router.py::test_upload_selfie_success PASSED [ 91%]
tests/integration/test_candidate_router.py::test_get_history PASSED      [ 95%]
tests/integration/test_flow.py::test_full_interview_lifecycle FAILED     [100%]

================================== FAILURES ===================================
_________ TestCascadeDelete.test_delete_candidate_cascades_interviews _________
tests\unit\test_cascade_delete.py:136: in test_delete_candidate_cascades_interviews
    assert remaining is None
E   AssertionError: assert InterviewSession(end_time=None, suspension_reason=None, admin_id=1, candidate_id=2, status=<InterviewStatus.SCHEDULED: 'SCHEDULED'>, suspended_at=None, invite_link=None, total_score=None, enrollment_audio_path=None, current_status='', paper_id=1, is_completed=False, schedule_time=datetime.datetime(2026, 2, 26, 11, 27, 19, 923672), last_activity=datetime.datetime(2026, 2, 26, 11, 27, 19, 925178), duration_minutes=60, warning_count=0, access_token='eb169c01091b4dbe8a0dfb06fa534829', max_questions=0, max_warnings=3, is_suspended=False, start_time=None, id=1) is None
__________________ TestCascadeDelete.test_cannot_delete_self __________________
tests\unit\test_cascade_delete.py:154: in test_cannot_delete_self
    assert "Cannot delete your own account" in response.json()["detail"]
                                               ^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'detail'
_______________ test_face_recognizer_builds_sface_even_on_cloud _______________
tests\unit\test_cloud_robustness.py:62: in test_face_recognizer_builds_sface_even_on_cloud
    mock_build.assert_called_once_with("SFace")
..\..\..\AppData\Local\Programs\Python\Python311\Lib\unittest\mock.py:950: in assert_called_once_with
    raise AssertionError(msg)
E   AssertionError: Expected 'build_model' to be called once. Called 0 times.
_________________________ test_access_interview_valid _________________________
tests\unit\test_interview.py:54: in test_access_interview_valid
    response = client.get(f"/api/interview/access/{interview.access_token}")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\starlette\testclient.py:473: in get
    return super().get(
.venv\Lib\site-packages\httpx\_client.py:1053: in get
    return self.request(
.venv\Lib\site-packages\starlette\testclient.py:445: in request
    return super().request(
.venv\Lib\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
.venv\Lib\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv\Lib\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\starlette\testclient.py:348: in handle_request
    raise exc
.venv\Lib\site-packages\starlette\testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
.venv\Lib\site-packages\anyio\from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
.venv\Lib\site-packages\anyio\from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\fastapi\applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv\Lib\site-packages\starlette\applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
.venv\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv\Lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv\Lib\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
.venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv\Lib\site-packages\fastapi\middleware\asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv\Lib\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv\Lib\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
.venv\Lib\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
.venv\Lib\site-packages\fastapi\routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
.venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv\Lib\site-packages\fastapi\routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\fastapi\routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv\Lib\site-packages\fastapi\routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app\routers\interview.py:57: in access_interview
    candidate_data = UserNested(
                     ^^^^^^^^^^
E   NameError: name 'UserNested' is not defined
------------------------------ Captured log call ------------------------------
ERROR    app.server:server.py:160 Global Exception: name 'UserNested' is not defined
Traceback (most recent call last):
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\fastapi\routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\fastapi\routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\fastapi\routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\fastapi\routing.py", line 243, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\app\routers\interview.py", line 57, in access_interview
    candidate_data = UserNested(
                     ^^^^^^^^^^
NameError: name 'UserNested' is not defined
________________________ test_full_interview_lifecycle ________________________
tests\integration\test_flow.py:45: in test_full_interview_lifecycle
    response = client.get(f"/api/interview/access/{interview.access_token}")
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\starlette\testclient.py:473: in get
    return super().get(
.venv\Lib\site-packages\httpx\_client.py:1053: in get
    return self.request(
.venv\Lib\site-packages\starlette\testclient.py:445: in request
    return super().request(
.venv\Lib\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
.venv\Lib\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
.venv\Lib\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\starlette\testclient.py:348: in handle_request
    raise exc
.venv\Lib\site-packages\starlette\testclient.py:345: in handle_request
    portal.call(self.app, scope, receive, send)
.venv\Lib\site-packages\anyio\from_thread.py:334: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py:456: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
..\..\..\AppData\Local\Programs\Python\Python311\Lib\concurrent\futures\_base.py:401: in __get_result
    raise self._exception
.venv\Lib\site-packages\anyio\from_thread.py:259: in _call_func
    retval = await retval_or_awaitable
             ^^^^^^^^^^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\fastapi\applications.py:1135: in __call__
    await super().__call__(scope, receive, send)
.venv\Lib\site-packages\starlette\applications.py:107: in __call__
    await self.middleware_stack(scope, receive, send)
.venv\Lib\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
.venv\Lib\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
.venv\Lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
.venv\Lib\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
.venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
.venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv\Lib\site-packages\fastapi\middleware\asyncexitstack.py:18: in __call__
    await self.app(scope, receive, send)
.venv\Lib\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
.venv\Lib\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
.venv\Lib\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
.venv\Lib\site-packages\fastapi\routing.py:115: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
.venv\Lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
.venv\Lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
.venv\Lib\site-packages\fastapi\routing.py:101: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
.venv\Lib\site-packages\fastapi\routing.py:355: in app
    raw_response = await run_endpoint_function(
.venv\Lib\site-packages\fastapi\routing.py:243: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
app\routers\interview.py:57: in access_interview
    candidate_data = UserNested(
                     ^^^^^^^^^^
E   NameError: name 'UserNested' is not defined
------------------------------ Captured log call ------------------------------
ERROR    app.server:server.py:160 Global Exception: name 'UserNested' is not defined
Traceback (most recent call last):
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\middleware\errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\middleware\exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\fastapi\middleware\asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\fastapi\routing.py", line 115, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\fastapi\routing.py", line 101, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\fastapi\routing.py", line 355, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\.venv\Lib\site-packages\fastapi\routing.py", line 243, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Sameer\OneDrive\Desktop\AI_Interview_Backend\app\routers\interview.py", line 57, in access_interview
    candidate_data = UserNested(
                     ^^^^^^^^^^
NameError: name 'UserNested' is not defined
=========================== short test summary info ===========================
FAILED tests/unit/test_cascade_delete.py::TestCascadeDelete::test_delete_candidate_cascades_interviews
FAILED tests/unit/test_cascade_delete.py::TestCascadeDelete::test_cannot_delete_self
FAILED tests/unit/test_cloud_robustness.py::test_face_recognizer_builds_sface_even_on_cloud
FAILED tests/unit/test_interview.py::test_access_interview_valid - NameError:...
FAILED tests/integration/test_flow.py::test_full_interview_lifecycle - NameEr...
======================== 5 failed, 19 passed in 3.61s =========================
